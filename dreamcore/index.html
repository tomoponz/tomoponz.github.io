<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>WAKE UP.</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  
  <script>
    // --- 壁の当たり判定 ---
    AFRAME.registerComponent('grid-collider', {
      init: function () {
        this.lastLocalPos = new THREE.Vector3().copy(this.el.object3D.position);
      },
      tick: function () {
        const worldPos = new THREE.Vector3();
        this.el.object3D.getWorldPosition(worldPos);
        const gX = Math.round(worldPos.x / 10);
        const gZ = Math.round(worldPos.z / 10);
        
        if (gZ >= 0 && gZ < mapData.length && gX >= 0 && gX < mapData[0].length) {
          if (mapData[gZ][gX] === 1) {
            this.el.object3D.position.copy(this.lastLocalPos); 
          } else {
            this.lastLocalPos.copy(this.el.object3D.position); 
          }
        } else {
          this.el.object3D.position.copy(this.lastLocalPos);
        }
      }
    });
  </script>

  <style>
    #phase-3d {
      position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
      opacity: 0; pointer-events: none; z-index: -10;
    }
    #phase-3d.active {
      opacity: 1; pointer-events: auto; z-index: 1000;
    }
  </style>
</head>
<body>

  <div id="phase-2d">
    <svg id="svg-filter" style="width:0; height:0; position:absolute;">
      <filter id="horror-warp">
        <feTurbulence type="fractalNoise" baseFrequency="0.01" numOctaves="3" seed="1">
          <animate attributeName="baseFrequency" values="0.01;0.015;0.01" dur="5s" repeatCount="indefinite" />
        </feTurbulence>
        <feDisplacementMap in="SourceGraphic" scale="40" />
      </filter>
    </svg>
    <div class="world-container">
      <div class="sky"></div><div class="ground"></div>
      <div class="scenery-overlay">
        <img src="../img/cloud.jpg" class="dream-obj cloud-1"><img src="../img/cloud.jpg" class="dream-obj cloud-2"><img src="../img/rainbow.jpg" class="dream-obj rainbow-mirror"><img src="../img/dolphin.jpg" class="dream-obj leaps">
      </div>
    </div>
    <div class="vignette"></div><div class="grain"></div><div class="vhs-lines"></div>
    <div class="main-title">Wake up.</div>
    <div id="button-hell"></div>
    <button class="the-exit" id="real-exit">I want to wake up.</button>
    <div class="eye-watcher" style="top:10%; left:20%;"><div class="eye"><div class="pupil"></div></div></div>
    <img src="../img/beach.jpg" class="loose-pic" style="bottom:20%; left:5%; width:150px; rotate:-10deg;">
    <img src="../img/CD.jpg" class="loose-pic" style="top:30%; right:15%; width:80px; opacity:0.6;">
  </div>


  <div id="phase-3d">
    <div class="hud-timer" id="timer-display">EXPLORE MODE</div>
    <div class="hud-vignette" id="hud-vignette"></div>

    <a-scene embedded fog="type: exponential; color: #000; density: 0.01;">
      
      <a-entity id="player" position="10 1.6 70">
        <a-camera id="main-cam" look-controls="pointerLockEnabled: true" wasd-controls="acceleration: 60" grid-collider>
          <a-cursor color="#fff" scale="0.5 0.5 0.5"></a-cursor>
        </a-camera>
        <a-light type="point" color="#fff" intensity="1.2" distance="60" position="0 2 0"></a-light>
      </a-entity>

      <a-entity id="map-root"></a-entity>

      <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
    </a-scene>
  </div>

  <script>
    const exitBtn = document.getElementById('real-exit');
    const hell = document.getElementById('button-hell');
    exitBtn.addEventListener('mouseenter', function() {
      if (Math.random() < 0.98) {
        const dummy = document.createElement('button'); dummy.className = 'the-exit dummy'; dummy.innerText = "I want to wake up."; dummy.style.left = this.style.left || '50%'; dummy.style.top = this.style.top || '80%'; hell.appendChild(dummy);
        this.style.left = (Math.random() * (window.innerWidth - 200)) + 'px'; this.style.top = (Math.random() * (window.innerHeight - 100)) + 'px'; this.style.position = 'fixed'; this.style.transform = 'none';
      }
    });

    const mapData = [
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1],
      [1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1],
      [1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1],
      [1, 0, 1, 0, 1, 1, 0, 1, 1, 0, 0, 1, 0, 0, 1],
      [1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1],
      [1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1],
      [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1], // Z=7, X=1 がスタート地点
      [1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1],
      [1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
    ];
    
    const UNIT = 10; 
    const mapWidth = mapData[0].length * UNIT;
    const mapDepth = mapData.length * UNIT;

    // 画像を使わず、色(Color)だけで空間を作る
    function generateMap() {
      const root = document.getElementById('map-root');

      // 巨大な床 (少し緑がかったグレー)
      const floor = document.createElement('a-plane');
      floor.setAttribute('position', `${(mapWidth/2) - (UNIT/2)} 0 ${(mapDepth/2) - (UNIT/2)}`);
      floor.setAttribute('rotation', '-90 0 0');
      floor.setAttribute('width', mapWidth);
      floor.setAttribute('height', mapDepth);
      floor.setAttribute('color', '#4a504a'); // 画像指定を削除し、色だけにする
      root.appendChild(floor);

      // 巨大な天井 (濃いグレー)
      const ceil = document.createElement('a-plane');
      ceil.setAttribute('position', `${(mapWidth/2) - (UNIT/2)} 6 ${(mapDepth/2) - (UNIT/2)}`);
      ceil.setAttribute('rotation', '90 0 0');
      ceil.setAttribute('width', mapWidth); 
      ceil.setAttribute('height', mapDepth);
      ceil.setAttribute('color', '#1a1a1a'); 
      root.appendChild(ceil);

      // 壁の生成 (無機質なグレーの箱)
      mapData.forEach((row, z) => {
        row.forEach((cell, x) => {
          if (cell === 1) {
            const posX = x * UNIT; 
            const posZ = z * UNIT;
            const wall = document.createElement('a-box');
            wall.setAttribute('position', `${posX} 3 ${posZ}`);
            wall.setAttribute('width', UNIT);
            wall.setAttribute('height', 6);
            wall.setAttribute('depth', UNIT);
            wall.setAttribute('color', '#888888'); // 画像指定を削除
            root.appendChild(wall);
          }
        });
      });
    }

    generateMap(); 

    // ボタンを押した時の画面切り替え
    exitBtn.addEventListener('click', () => {
      document.getElementById('svg-filter').remove(); 
      document.getElementById('phase-2d').style.opacity = '0';
      setTimeout(() => { document.getElementById('phase-2d').style.display = 'none'; }, 500);
      
      document.getElementById('phase-3d').classList.add('active');
      window.dispatchEvent(new Event('resize'));
    });
    
    document.addEventListener('mousemove', (e) => { 
      document.querySelectorAll('.eye').forEach(eye => { 
        const rect = eye.getBoundingClientRect(); const x = rect.left + rect.width / 2; const y = rect.top + rect.height / 2; 
        const rot = (Math.atan2(e.clientX - x, e.clientY - y) * (180 / Math.PI) * -1) + 180; eye.style.transform = `rotate(${rot}deg)`; 
      }); 
    });
  </script>
</body>
</html>
