<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>RUN.</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  
  <svg style="width:0; height:0; position:absolute;">
    <filter id="horror-warp">
      <feTurbulence type="fractalNoise" baseFrequency="0.01" numOctaves="5" seed="1">
        <animate attributeName="baseFrequency" values="0.01;0.015;0.01" dur="5s" repeatCount="indefinite" />
      </feTurbulence>
      <feDisplacementMap in="SourceGraphic" scale="40" />
    </filter>
  </svg>

  <div class="world-container" id="world">
    <div class="sky"></div>
    <div class="ground"></div>
    
    <div class="scenery-overlay">
      <img src="../img/cloud.png" class="dream-obj cloud-1">
      <img src="../img/cloud.png" class="dream-obj cloud-2">
      <img src="../img/rainbow.png" class="dream-obj rainbow-mirror">
    </div>
  </div>

  <div class="vignette" id="vignette"></div>
  <div class="grain"></div>
  <div class="vhs-lines"></div>

  <div class="nightmare-clock">
    <div class="clock-inner">
      <div class="hand hour" id="h"></div>
      <div class="hand min" id="m"></div>
      <div class="hand sec" id="s"></div>
    </div>
  </div>

  <div class="main-title" id="text-primary">Wake up.</div>

  <div id="click-chaos-container"></div>
  <div id="button-hell"></div>

  <a href="../aero/index.html" class="the-exit" id="real-exit">I want to wake up.</a>

  <div id="entity" class="glitch-entity">
    <div class="entity-core"></div>
    <div class="entity-aura"></div>
    <div class="eye"><div class="pupil" style="background: red; box-shadow: 0 0 20px yellow;"></div></div>
  </div>

  <div class="game-over-screen" id="game-over">
    <h1>YOU WERE CAUGHT.</h1>
    <p>Returning to Level 0...</p>
  </div>

  <script>
    // --- 1. 時計の狂った回転 ---
    let ang = 0;
    setInterval(() => {
      ang -= 20;
      document.getElementById('s').style.transform = `translateX(-50%) rotate(${ang}deg)`;
      document.getElementById('m').style.transform = `translateX(-50%) rotate(${ang/12}deg)`;
      document.getElementById('h').style.transform = `translateX(-50%) rotate(${ang/60}deg)`;
    }, 40);

    // --- 2. 理論値脱出ボタン ---
    const exit = document.getElementById('real-exit');
    const hell = document.getElementById('button-hell');
    
    exit.addEventListener('mouseenter', function() {
      if (Math.random() < 0.98) teleport(this);
    });

    function teleport(btn) {
      const dummy = document.createElement('div');
      dummy.className = 'the-exit dummy';
      dummy.innerText = "I want to wake up.";
      dummy.style.left = btn.style.left || '50%';
      dummy.style.top = btn.style.top || '80%';
      hell.appendChild(dummy);

      const x = Math.random() * (window.innerWidth - 200);
      const y = Math.random() * (window.innerHeight - 100);
      btn.style.left = x + 'px';
      btn.style.top = y + 'px';
      btn.style.position = 'fixed';
      btn.style.transform = 'none';
    }

    // --- 3. 追跡者 (Glitch Entity) のロジック ---
    const entity = document.getElementById('entity');
    const world = document.getElementById('world');
    const vignette = document.getElementById('vignette');
    const mainText = document.getElementById('text-primary');
    
    // カーソルの位置（初期値は画面中央）
    let mouseX = window.innerWidth / 2;
    let mouseY = window.innerHeight / 2;
    // 怪物の位置（初期値は画面外からスタート）
    let entityX = -200;
    let entityY = -200;
    // 怪物の移動速度
    let speed = 2.5; 
    let isGameOver = false;

    // マウス座標の更新
    document.addEventListener('mousemove', (e) => {
      mouseX = e.clientX;
      mouseY = e.clientY;
    });

    // タッチデバイス（スマホ）用
    document.addEventListener('touchmove', (e) => {
      mouseX = e.touches[0].clientX;
      mouseY = e.touches[0].clientY;
    }, {passive: true});

    function updateEntity() {
      if (isGameOver) return;

      // 怪物がカーソルに向かって移動する計算
      const dx = mouseX - entityX;
      const dy = mouseY - entityY;
      const distance = Math.sqrt(dx * dx + dy * dy);

      if (distance > 0) {
        entityX += (dx / distance) * speed;
        entityY += (dy / distance) * speed;
      }

      // 怪物の位置を更新
      entity.style.left = entityX + 'px';
      entity.style.top = entityY + 'px';

      // --- 距離に応じた恐怖演出の強化 ---
      // 距離が近いほど、画面の歪み、暗さ、テキストの揺れが激しくなる
      const dangerLevel = Math.max(0, 1 - (distance / 500)); // 0(安全) 〜 1(激ヤバ)

      // 背景の赤黒さ
      vignette.style.background = `radial-gradient(circle, transparent ${20 - dangerLevel * 20}%, rgba(${dangerLevel * 150},0,0,0.9) 100%)`;
      
      // 世界のノイズ強化
      world.style.filter = `url(#horror-warp) contrast(${1.2 + dangerLevel}) saturate(${1.5 + dangerLevel * 2}) hue-rotate(${dangerLevel * 90}deg)`;

      // メインテキストのパニック度
      mainText.style.letterSpacing = (dangerLevel * 50) + 'px';
      mainText.style.transform = `translate(-50%, -50%) scale(${1 + dangerLevel * 0.5}) skew(${dangerLevel * 20}deg)`;
      
      // 目玉をカーソルに向ける
      const eye = entity.querySelector('.eye');
      const rad = Math.atan2(mouseX - entityX, mouseY - entityY);
      const rot = (rad * (180 / Math.PI) * -1) + 180;
      eye.style.transform = `rotate(${rot}deg)`;

      // --- 捕獲判定 ---
      // 怪物の中心（コア）にカーソルが触れたらゲームオーバー
      if (distance < 30) {
        gameOver();
      } else {
        // 時間経過で少しずつ怪物がスピードアップする（最大速度あり）
        if (speed < 7) speed += 0.001; 
        requestAnimationFrame(updateEntity);
      }
    }

    function gameOver() {
      isGameOver = true;
      document.getElementById('game-over').style.opacity = 1;
      document.body.style.cursor = 'none'; // カーソルを消す絶望感
      
      // 少し待ってから Backrooms(Level 0) に強制送還
      setTimeout(() => {
        window.location.href = '../liminal/index.html';
      }, 3000);
    }

    // 追跡開始
    requestAnimationFrame(updateEntity);

    // クリック時の発火（邪魔な文字を出す）
    document.addEventListener('click', (e) => {
      if(e.target.id === 'real-exit' || isGameOver) return;
      
      const txt = document.createElement('div');
      txt.className = 'pop-text';
      txt.innerText = "RUN";
      txt.style.left = e.clientX + 'px';
      txt.style.top = e.clientY + 'px';
      document.getElementById('click-chaos-container').appendChild(txt);
      
      document.body.style.animation = 'shake 0.1s infinite';
      setTimeout(() => { document.body.style.animation = ''; }, 200);
    });

  </script>
</body>
</html>
