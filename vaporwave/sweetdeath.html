<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>甘き死よ、来たれ</title>
  <meta name="description" content="甘き死よ、来たれ | Freddie Mercury AI Cover を再生するページ">

  <style>
    :root{
      --bg0:#05030a;
      --bg1:#120516;
      --ink:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.62);
      --glass:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.14);
    }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 50% 40%, rgba(173, 78, 255, .16), transparent 60%),
                  radial-gradient(900px 600px at 30% 70%, rgba(255, 120, 160, .10), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--ink);
      font-family: "游明朝", "Yu Mincho", "ＭＳ Ｐ明朝", serif;
      overflow:hidden;
      user-select:none;
    }

    /* subtle noise */
    .noise{
      position:fixed; inset:0;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" opacity="0.25"/></svg>');
      mix-blend-mode: overlay;
      opacity:.14;
      pointer-events:none;
    }

    /* vignette */
    .vig{ position:fixed; inset:-40px; pointer-events:none;
      background: radial-gradient(circle at 50% 45%, transparent 35%, rgba(0,0,0,.55) 78%);
      opacity:.9;
    }

    /* start overlay */
    #start{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.92);
      z-index: 50;
      cursor:pointer;
      transition: opacity 1.8s ease;
    }
    .startBox{ text-align:center; padding:24px; }
    .jpTitle{ font-size: clamp(42px, 7vw, 84px); letter-spacing: .18em; }
    .sub{ margin-top: 14px; color: var(--mut); letter-spacing:.24em; font-size: 13px; }
    .tap{ margin-top: 26px; font-size: 12px; color: rgba(255,255,255,.7); letter-spacing:.3em;
      animation: pulse 2.0s infinite; }
    @keyframes pulse{ 0%,100%{ opacity:1; } 50%{ opacity:.35; } }

    /* layout */
    .stage{
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap: 18px;
      padding: 24px;
    }

    .headline{
      text-align:center;
      opacity:0;
      transform: translateY(8px);
      transition: opacity 2.2s ease 1.0s, transform 2.2s ease 1.0s;
    }
    .headline .h1{
      font-size: clamp(28px, 4.4vw, 50px);
      letter-spacing:.22em;
      margin:0;
      text-shadow: 0 12px 34px rgba(0,0,0,.65);
    }
    .headline .h2{
      margin:10px 0 0;
      color: var(--mut);
      font-size: 12px;
      letter-spacing:.28em;
    }

    /* cassette/radio */
    .deck{
      width:min(620px, 92vw);
      aspect-ratio: 16/9;
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border: 1px solid var(--line);
      box-shadow: 0 30px 70px rgba(0,0,0,.65), inset 0 1px 0 rgba(255,255,255,.12);
      display:flex;
      overflow:hidden;
      opacity:0;
      transform: translateY(16px);
      transition: opacity 2.2s ease 1.4s, transform 2.2s ease 1.4s;
      backdrop-filter: blur(10px);
    }
    .screen{
      flex: 1;
      position:relative;
      background: rgba(0,0,0,.65);
      border-right: 1px solid rgba(255,255,255,.10);
    }
    .screen::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,.22) 50%);
      background-size: 100% 4px;
      opacity:.45;
      pointer-events:none;
    }
    #player{ position:absolute; inset:0; }
    .panel{
      width: 170px;
      padding: 16px;
      display:flex; flex-direction:column; justify-content:space-between;
      gap: 10px;
    }
    .label{ font-size: 11px; letter-spacing:.22em; color: rgba(255,255,255,.7); }
    .knobRow{ display:flex; gap:10px; align-items:center; }
    .knob{
      width: 44px; height: 44px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), rgba(0,0,0,.35));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), 0 8px 24px rgba(0,0,0,.45);
      position:relative;
    }
    .knob::after{
      content:"";
      position:absolute; top: 7px; left: 21px;
      width: 3px; height: 12px;
      background: rgba(255,255,255,.8);
      border-radius: 2px;
      transform: rotate(20deg);
      transform-origin: center 16px;
    }
    .tiny{ font-size: 11px; color: rgba(255,255,255,.6); line-height:1.5; }

    .btnRow{ display:flex; gap:10px; }
    .btn{
      flex:1;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.78);
      padding: 10px 12px;
      font-size: 12px;
      letter-spacing:.18em;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.08); }
    .btn:active{ transform: translateY(1px); }

    .return{
      position:fixed; left: 22px; bottom: 18px;
      z-index: 10;
      color: rgba(255,255,255,.6);
      border: 1px solid rgba(255,255,255,.22);
      padding: 10px 14px;
      border-radius: 14px;
      text-decoration:none;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      opacity:0;
      transition: opacity 1.6s ease 2.2s, transform 1.6s ease 2.2s;
      transform: translateY(6px);
    }
    .return:hover{ color:#fff; background: rgba(255,255,255,.08); }

    @media (max-width: 640px){
      .deck{ flex-direction:column; aspect-ratio:auto; }
      .panel{ width:auto; }
      .screen{ height: 46vh; border-right:none; border-bottom: 1px solid rgba(255,255,255,.10); }
    }
  </style>
</head>
<body>
  <div class="noise"></div>
  <div class="vig"></div>

  <div id="start" aria-label="start">
    <div class="startBox">
      <div class="jpTitle">甘き死よ、来たれ</div>
      <div class="sub">Freddie Mercury AI Cover</div>
      <div class="tap">（タップして開始）</div>
    </div>
  </div>

  <a class="return" id="return" href="../index.html">現 実 へ 帰 還</a>

  <div class="stage">
    <div class="headline" id="headline">
      <h1 class="h1">COME SWEET DEATH</h1>
      <div class="h2">nostalgic / fragile / quiet</div>
    </div>

    <div class="deck" id="deck">
      <div class="screen">
        <div id="player"></div>
      </div>
      <div class="panel">
        <div>
          <div class="label">TAPE DECK</div>
          <div class="knobRow" style="margin-top:10px">
            <div class="knob" aria-hidden="true"></div>
            <div class="knob" aria-hidden="true"></div>
          </div>
          <div class="tiny" style="margin-top:10px">
            ※音量は端末側。<br>
            ※音声OFFなら再生しない。
          </div>
        </div>
        <div>
          <div class="btnRow">
            <button class="btn" type="button" id="btnPlay">PLAY</button>
            <button class="btn" type="button" id="btnPause">PAUSE</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>

    (function(){
      // Gate: sweetdeath.html can be opened ONLY via Aero's "ごみ箱を空にする"
      const KEY = "tpz_gate_sweetdeath_v1";
      let ts = 0;
      try{ ts = Number(localStorage.getItem(KEY) || 0); }catch(_){ ts = 0; }
      const ok = ts && (Date.now() - ts) < 2 * 60 * 1000; // 2 minutes
      if(!ok){
        try{ location.replace("../aero/index.html"); }catch(_){ location.href = "../aero/index.html"; }
        return;
      }
      try{ localStorage.removeItem(KEY); }catch(_){ }

      // achievements-lite: mark page view (this page doesn't load app.js)
      const ACH_KEY = "tomoponz_ach_v1";
      function achLoad(){
        try{
          const raw = localStorage.getItem(ACH_KEY);
          if(!raw) return {v:1, pages:{}, counters:{}, unlocked:{}};
          const o = JSON.parse(raw);
          if(!o || typeof o !== "object") return {v:1, pages:{}, counters:{}, unlocked:{}};
          o.v = 1;
          o.pages = (o.pages && typeof o.pages === "object") ? o.pages : {};
          o.counters = (o.counters && typeof o.counters === "object") ? o.counters : {};
          o.unlocked = (o.unlocked && typeof o.unlocked === "object") ? o.unlocked : {};
          return o;
        }catch(_){ return {v:1, pages:{}, counters:{}, unlocked:{}}; }
      }
      function achSave(s){ try{ localStorage.setItem(ACH_KEY, JSON.stringify(s)); }catch(_){ } }
      try{
        const path = String(location.pathname||"").replace(/^\/+/, "");
        const s = achLoad();
        s.counters.visits = (Number(s.counters.visits)||0) + 1;
        s.pages[path] = Date.now();
        achSave(s);
      }catch(_){ }
    })();

    const VIDEO_ID = "qXtQPRdHNdA";
    let player = null;
    let started = false;
    let booted = false;

    function postToShell(msg){
      try{
        if(window.parent && window.parent !== window){
          window.parent.postMessage(msg, location.origin);
        }
      }catch(_){ }
    }

    // ここは“没入”したいので、入った瞬間にメニューを隠す
    postToShell({type:"IMMERSION", active:true});

    // achievements：vaporwaveページ訪問を記録（localStorageのみ）
    (function(){
      const K="tomoponz_ach_v1";
      try{
        const raw=localStorage.getItem(K);
        const s=raw?JSON.parse(raw):{v:1,pages:{},counters:{},unlocked:{}};
        s.pages=s.pages&&typeof s.pages==="object"?s.pages:{};
        s.counters=s.counters&&typeof s.counters==="object"?s.counters:{};
        s.unlocked=s.unlocked&&typeof s.unlocked==="object"?s.unlocked:{};
        s.pages["vaporwave/sweetdeath.html"]=true;
        s.counters.visits=(Number(s.counters.visits)||0)+1;
        localStorage.setItem(K, JSON.stringify(s));
      }catch(_){ }
    })();

    function ensureAPI(){
      return new Promise((resolve)=>{
        if(window.YT && window.YT.Player){ return resolve(); }
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(tag);
        window.onYouTubeIframeAPIReady = ()=>resolve();
      });
    }

    async function boot(){
      booted = true;
      const start = document.getElementById('start');
      start.style.opacity = '0';
      setTimeout(()=>{ start.style.display = 'none'; }, 1800);

      document.getElementById('headline').style.opacity = '1';
      document.getElementById('headline').style.transform = 'translateY(0)';
      document.getElementById('deck').style.opacity = '1';
      document.getElementById('deck').style.transform = 'translateY(0)';
      const ret = document.getElementById('return');
      ret.style.opacity = '1';
      ret.style.transform = 'translateY(0)';

      // 音声OFFならプレイヤーを作らない（静かな鑑賞にも対応）
      try{ if(window.getAudioEnabled && !window.getAudioEnabled()) return; }catch(_){ }

      await ensureAPI();
      if(player) return;
      player = new YT.Player('player', {
        videoId: VIDEO_ID,
        playerVars: {
          autoplay: 1,
          controls: 0,
          disablekb: 1,
          modestbranding: 1,
          rel: 0,
          playsinline: 1,
          loop: 1,
          playlist: VIDEO_ID
        },
        events: {
          onReady: (ev)=>{
            started = true;
            try{ ev.target.playVideo(); }catch(_){ }
          }
        }
      });
    }

    function play(){
      if(!player){ return; }
      try{ player.playVideo(); }catch(_){ }
    }
    function pause(){
      if(!player){ return; }
      try{ player.pauseVideo(); }catch(_){ }
    }

    document.getElementById('start').addEventListener('click', boot);
    document.getElementById('btnPlay').addEventListener('click', ()=>{
      if(!started){ boot(); return; }
      play();
    });
    document.getElementById('return').addEventListener('click', (e)=>{
      // shell(iframe) のときは親に遷移を委譲（URL同期）
      try{
        if(window.parent && window.parent !== window){
          e.preventDefault();
          postToShell({type:'NAV', href: new URL('../index.html', location.href).href});
        }
      }catch(_){ }
    });

    window.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        try{ postToShell({type:'NAV', href: new URL('../index.html', location.href).href}); }catch(_){ }
      }
    });

    document.getElementById('btnPause').addEventListener('click', pause);

    // shell/app からの停止・音声ON/OFFに追従
    window.addEventListener('message', (ev)=>{
      const d = ev.data || {};
      if(!d || typeof d !== 'object') return;
      if(d.type === 'STOP_MEDIA'){
        pause();
      }
      if(d.type === 'AUDIO'){
        const on = !!d.enabled;
        if(!on){
          pause();
          try{ player && player.mute && player.mute(); }catch(_){ }
        }else{
          // いったん静音で起動していた場合、ONになった瞬間にプレイヤーを生成
          if(booted && !player){
            // ユーザー操作済みならOK（start画面クリック）
            boot();
            return;
          }
          try{ player && player.unMute && player.unMute(); }catch(_){ }
          if(started) play();
        }
      }
    });

    // 離脱時は immersive を解除（保険）
    window.addEventListener('beforeunload', ()=>{
      postToShell({type:"IMMERSION", active:false});
    });
  </script>
</body>
</html>
