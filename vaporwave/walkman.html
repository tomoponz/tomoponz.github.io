<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WALKMAN</title>
  <meta name="description" content="ウォークマン風プレイヤー（YouTube埋め込み）">

  <style>
    :root{
      --bg0:#05060a;
      --bg1:#0b0e16;
      --ink:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.62);
      --line:rgba(255,255,255,.14);
      --glass:rgba(255,255,255,.08);
      --accent:#8b5cff;
      --accent2:#ff5aa5;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:
        radial-gradient(900px 700px at 35% 30%, rgba(139,92,255,.16), transparent 60%),
        radial-gradient(900px 700px at 70% 75%, rgba(255,90,165,.10), transparent 60%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
      color:var(--ink);
      font-family: ui-serif, "游明朝", "Yu Mincho", "ＭＳ Ｐ明朝", serif;
      overflow:hidden;
      user-select:none;
    }

    /* subtle grain */
    .noise{position:fixed;inset:0;pointer-events:none;opacity:.12;mix-blend-mode:overlay;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" opacity="0.25"/></svg>');
    }
    .vig{position:fixed;inset:-40px;pointer-events:none;opacity:.9;
      background: radial-gradient(circle at 50% 45%, transparent 35%, rgba(0,0,0,.58) 78%);
    }

    /* start */
    #start{
      position:fixed;inset:0;z-index:50;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.92);
      cursor:pointer;
      transition:opacity 1.6s ease;
    }
    .startBox{text-align:center;padding:26px;}
    .t1{font-size:clamp(34px,5.4vw,62px);letter-spacing:.22em;}
    .t2{margin-top:12px;color:var(--mut);letter-spacing:.26em;font-size:12px;}
    .tap{margin-top:24px;font-size:12px;color:rgba(255,255,255,.72);letter-spacing:.32em;animation:pulse 2s infinite;}
    @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.35;}}

    /* layout */
    .stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:24px;}

    .wm{
      width:min(420px,92vw);
      height:min(640px,86vh);
      border-radius:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid var(--line);
      box-shadow: 0 34px 88px rgba(0,0,0,.68), inset 0 1px 0 rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      position:relative;
      overflow:hidden;
      opacity:0;
      transform: translateY(14px);
      transition: opacity 2.0s ease 1.0s, transform 2.0s ease 1.0s;
    }

    .wm::before{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(135deg, rgba(139,92,255,.10), transparent 42%),
                  linear-gradient(225deg, rgba(255,90,165,.08), transparent 50%);
      pointer-events:none;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .brand{letter-spacing:.24em;font-size:12px;color:rgba(255,255,255,.78)}
    .status{font-size:11px;letter-spacing:.18em;color:rgba(255,255,255,.55)}

    .window{
      margin:16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
      box-shadow: inset 0 0 26px rgba(0,0,0,.9);
      overflow:hidden;
      position:relative;
      cursor:pointer;
    }
    .window::before{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,.22) 50%);
      background-size:100% 4px;
      opacity:.42;
      pointer-events:none;
      z-index:2;
    }
    .thumb{
      width:100%;
      aspect-ratio: 16/9;
      object-fit:cover;
      display:block;
      opacity:.92;
      transform: scale(1.02);
      filter: contrast(1.06) saturate(1.05);
    }
    .overlay{
      position:absolute;inset:0;
      display:flex;align-items:flex-end;justify-content:space-between;
      padding:12px;
      z-index:3;
      background: linear-gradient(180deg, transparent 55%, rgba(0,0,0,.78));
    }
    .track{
      min-width:0;
      padding-right:10px;
    }
    .track .name{
      font-size:13px;
      letter-spacing:.16em;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      margin:0;
    }
    .track .meta{margin:6px 0 0;color:rgba(255,255,255,.6);font-size:11px;letter-spacing:.12em;}

    .badge{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      border-radius:999px;
      padding:7px 10px;
      font-size:11px;
      letter-spacing:.18em;
      color:rgba(255,255,255,.8);
    }

    .controls{
      padding: 6px 16px 16px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
    }
    .btn{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.82);
      padding: 12px 14px;
      font-size: 12px;
      letter-spacing:.18em;
      cursor:pointer;
      min-width: 92px;
      transition: transform .12s ease, background .12s ease;
    }
    .btn:hover{background:rgba(255,255,255,.08);}
    .btn:active{transform: translateY(1px);}

    .hint{padding:0 18px 16px;color:rgba(255,255,255,.55);font-size:11px;letter-spacing:.16em;line-height:1.6;}

    .return{
      position:fixed;left:22px;bottom:18px;z-index:10;
      color:rgba(255,255,255,.6);
      border:1px solid rgba(255,255,255,.22);
      padding: 10px 14px;
      border-radius:14px;
      text-decoration:none;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      opacity:0;
      transform: translateY(6px);
      transition: opacity 1.6s ease 1.6s, transform 1.6s ease 1.6s;
    }
    .return:hover{color:#fff;background:rgba(255,255,255,.08);}

    /* hidden YT player (audio only) */
    #playerWrap{position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;pointer-events:none;}

    @media (max-width:520px){
      .btn{min-width: 86px;padding: 12px 10px;}
    }
  </style>
</head>
<body>
  <div class="noise"></div>
  <div class="vig"></div>

  <div id="start" aria-label="start">
    <div class="startBox">
      <div class="t1">WALKMAN</div>
      <div class="t2">tap to boot</div>
      <div class="tap">（タップして開始）</div>
    </div>
  </div>

  <a class="return" id="return" href="../index.html">現 実 へ 帰 還</a>

  <div class="stage">
    <div class="wm" id="wm">
      <div class="topbar">
        <div class="brand">EVA • PLAYER</div>
        <div class="status" id="status">standby</div>
      </div>

      <div class="window" id="window" title="クリックで次の曲">
        <img class="thumb" id="thumb" alt="thumbnail" src="" />
        <div class="overlay">
          <div class="track">
            <p class="name" id="trackName">---</p>
            <p class="meta" id="trackMeta">--/--</p>
          </div>
          <div class="badge" id="badge">NEXT</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="btnPrev" type="button">PREV</button>
        <button class="btn" id="btnPlay" type="button">PLAY</button>
        <button class="btn" id="btnNext" type="button">NEXT</button>
      </div>

      <div class="hint">
        画像をタップすると次の曲。<br>
        ※ 音声OFFなら再生しない。
      </div>

      <div id="playerWrap"><div id="player"></div></div>
    </div>
  </div>

  <script>

    (function(){
      // Gate: walkman.html can be opened ONLY via Dreamcore's clear screen × button
      const KEY = "tpz_gate_walkman_v1";
      let ts = 0;
      try{ ts = Number(localStorage.getItem(KEY) || 0); }catch(_){ ts = 0; }
      const ok = ts && (Date.now() - ts) < 2 * 60 * 1000; // 2 minutes
      if(!ok){
        try{ location.replace("../dreamcore/index.html"); }catch(_){ location.href = "../dreamcore/index.html"; }
        return;
      }
      try{ localStorage.removeItem(KEY); }catch(_){ }

      // achievements-lite: mark page view (this page doesn't load app.js)
      const ACH_KEY = "tomoponz_ach_v1";
      function achLoad(){
        try{
          const raw = localStorage.getItem(ACH_KEY);
          if(!raw) return {v:1, pages:{}, counters:{}, unlocked:{}};
          const o = JSON.parse(raw);
          if(!o || typeof o !== "object") return {v:1, pages:{}, counters:{}, unlocked:{}};
          o.v = 1;
          o.pages = (o.pages && typeof o.pages === "object") ? o.pages : {};
          o.counters = (o.counters && typeof o.counters === "object") ? o.counters : {};
          o.unlocked = (o.unlocked && typeof o.unlocked === "object") ? o.unlocked : {};
          return o;
        }catch(_){ return {v:1, pages:{}, counters:{}, unlocked:{}}; }
      }
      function achSave(s){ try{ localStorage.setItem(ACH_KEY, JSON.stringify(s)); }catch(_){ } }
      try{
        const path = String(location.pathname||"").replace(/^\/+/, "");
        const s = achLoad();
        s.counters.visits = (Number(s.counters.visits)||0) + 1;
        s.pages[path] = Date.now();
        achSave(s);
      }catch(_){ }
    })();

    // ====== config (EVA related; exclude Fly Me / Come Sweet Death) ======
    const TRACKS = [
      { title: '残酷な天使のテーゼ', id: 'xyVatKhd4s4' },
      { title: '魂のルフラン', id: 'LDpPos7DBGA' },
      { title: 'THANATOS', id: 'oWw730Dul8I' },
      { title: 'DECISIVE BATTLE', id: 'o1Eo3VW693Q' },
      { title: 'Beautiful World', id: 'jmKRgqWGrWc' },
      { title: 'One Last Kiss', id: '0Uhh62MUEic' },
    ];

    let idx = 0;
    let player = null;
    let started = false;
    let booted = false;

    function postToShell(msg){
      try{
        if(window.parent && window.parent !== window){
          window.parent.postMessage(msg, location.origin);
        }
      }catch(_){ }
    }

    // immersive: hide menu
    postToShell({type:'IMMERSION', active:true});

    function ensureAPI(){
      return new Promise((resolve)=>{
        if(window.YT && window.YT.Player) return resolve();
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(tag);
        window.onYouTubeIframeAPIReady = ()=>resolve();
      });
    }

    function ytThumb(id){
      // maxres may 404; hqdefault is safe.
      return `https://i.ytimg.com/vi/${id}/hqdefault.jpg`;
    }

    function render(){
      const t = TRACKS[idx];
      document.getElementById('thumb').src = ytThumb(t.id);
      document.getElementById('trackName').textContent = t.title;
      document.getElementById('trackMeta').textContent = `${idx+1}/${TRACKS.length}`;
    }

    function setStatus(s){
      const el = document.getElementById('status');
      if(el) el.textContent = s;
    }

    async function boot(){
      if(booted) return;
      booted = true;

      // fade start
      const start = document.getElementById('start');
      start.style.opacity = '0';
      setTimeout(()=>{ start.style.display = 'none'; }, 1600);

      // show UI
      document.getElementById('wm').style.opacity = '1';
      document.getElementById('wm').style.transform = 'translateY(0)';
      const ret = document.getElementById('return');
      ret.style.opacity = '1';
      ret.style.transform = 'translateY(0)';

      render();

      // audio OFF => don't create player
      try{ if(window.getAudioEnabled && !window.getAudioEnabled()){ setStatus('audio off'); return; } }catch(_){ }

      await ensureAPI();
      if(player) return;

      setStatus('loading');
      const first = TRACKS[idx];
      player = new YT.Player('player', {
        videoId: first.id,
        playerVars: {
          autoplay: 1,
          controls: 0,
          disablekb: 1,
          modestbranding: 1,
          rel: 0,
          playsinline: 1
        },
        events: {
          onReady: (ev)=>{
            started = true;
            setStatus('playing');
            try{ ev.target.playVideo(); }catch(_){ }
          },
          onStateChange: (ev)=>{
            // 0: ended
            if(ev.data === 0){
              next(true);
            }
          }
        }
      });
    }

    function play(){
      if(!player){ boot(); return; }
      try{ player.playVideo(); setStatus('playing'); }catch(_){ }
    }
    function pause(){
      if(!player) return;
      try{ player.pauseVideo(); setStatus('paused'); }catch(_){ }
    }

    function loadCurrent(){
      render();
      if(!player) return;
      try{
        player.loadVideoById(TRACKS[idx].id);
        setStatus('playing');
      }catch(_){ }
    }

    function next(auto){
      idx = (idx + 1) % TRACKS.length;
      loadCurrent();
      if(auto) return;
    }

    function prev(){
      idx = (idx - 1 + TRACKS.length) % TRACKS.length;
      loadCurrent();
    }

    // UI actions
    document.getElementById('start').addEventListener('click', boot);
    document.getElementById('btnPlay').addEventListener('click', play);
    document.getElementById('btnNext').addEventListener('click', ()=>next(false));
    document.getElementById('btnPrev').addEventListener('click', prev);
    document.getElementById('window').addEventListener('click', ()=>next(false));

    // return: delegate to shell
    document.getElementById('return').addEventListener('click', (e)=>{
      try{
        if(window.parent && window.parent !== window){
          e.preventDefault();
          postToShell({type:'NAV', href: new URL('../index.html', location.href).href});
        }
      }catch(_){ }
    });

    // shell/app messages
    window.addEventListener('message', (ev)=>{
      const d = ev.data || {};
      if(!d || typeof d !== 'object') return;
      if(d.type === 'STOP_MEDIA'){
        pause();
      }
      if(d.type === 'AUDIO'){
        const on = !!d.enabled;
        if(!on){
          pause();
          try{ player && player.mute && player.mute(); }catch(_){ }
          setStatus('audio off');
        }else{
          // if already booted but player not created (because audio was off), create it now
          if(booted && !player){
            boot();
            return;
          }
          try{ player && player.unMute && player.unMute(); }catch(_){ }
          if(started) play();
        }
      }
    });

    // safety: release immersive
    window.addEventListener('beforeunload', ()=>{ postToShell({type:'IMMERSION', active:false}); });
  </script>
</body>
</html>
