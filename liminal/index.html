<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Level 0 - The Backrooms</title>
  
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
  
  <link rel="stylesheet" href="style.css">

  <style>
    /* ビデオカメラ風UIのスタイル（変更なし） */
    #camcorder-ui {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 55; color: white;
      font-family: 'Courier New', Courier, monospace;
      text-shadow: 2px 2px 0px black;
    }
    .cam-rec { position: absolute; top: 30px; left: 40px; font-size: 28px; font-weight: bold; }
    .cam-rec span { color: red; animation: blink 1s infinite; }
    .cam-battery { position: absolute; top: 30px; right: 40px; font-size: 24px; border: 2px solid white; padding: 2px 8px; }
    .cam-timecode { position: absolute; bottom: 40px; left: 40px; font-size: 28px; letter-spacing: 2px; }
    .cam-date { position: absolute; bottom: 40px; right: 40px; font-size: 28px; letter-spacing: 2px; }
    .cam-center-cross { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; opacity: 0.5; }
    @keyframes blink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0; } }
  </style>

  <script>
    // 1. 足音再生
    AFRAME.registerComponent('footstep-sound', {
      init: function () {
        this.lastPos = new THREE.Vector3();
        this.el.object3D.getWorldPosition(this.lastPos);
        this.audio = document.getElementById("audio-footstep");
        this.isWalking = false;
      },
      tick: function () {
        if (!this.audio || !window.audioUnlocked) return;
        var currentPos = new THREE.Vector3();
        this.el.object3D.getWorldPosition(currentPos);
        var dx = currentPos.x - this.lastPos.x;
        var dz = currentPos.z - this.lastPos.z;
        var dist = dx * dx + dz * dz;

        if (dist > 0.00005) {
          if (!this.isWalking) { this.audio.play().catch(()=>{}); this.isWalking = true; }
        } else {
          if (this.isWalking) { this.audio.pause(); this.isWalking = false; }
        }
        this.lastPos.copy(currentPos);
      }
    });

    // 2. 壁すり抜け防止
    AFRAME.registerComponent('wall-collider', {
      init: function () {
        this.raycaster = new THREE.Raycaster();
        this.directions = [ new THREE.Vector3(1, 0, 0), new THREE.Vector3(-1, 0, 0), new THREE.Vector3(0, 0, 1), new THREE.Vector3(0, 0, -1) ];
        this.lastPos = new THREE.Vector3();
        this.el.object3D.getWorldPosition(this.lastPos);
      },
      tick: function () {
        var el = this.el; var pos = el.object3D.position;
        var wallEls = el.sceneEl.querySelectorAll('.collidable');
        var meshes = [];
        wallEls.forEach(function (wall) { if (wall.object3D) { wall.object3D.traverse(function (node) { if (node.isMesh) meshes.push(node); }); } });
        if (meshes.length === 0) { this.lastPos.copy(pos); return; }
        var collision = false;
        for (var i = 0; i < this.directions.length; i++) {
           this.raycaster.set(pos, this.directions[i]);
           var intersects = this.raycaster.intersectObjects(meshes, true);
           if (intersects.length > 0 && intersects[0].distance < 0.6) { collision = true; break; }
        }
        if (collision) { el.object3D.position.copy(this.lastPos); } else { this.lastPos.copy(pos); }
      }
    });

    // 3. 近づくと消える影
    AFRAME.registerComponent('shadow-watcher', {
      tick: function () {
        var player = document.getElementById('rig'); if (!player) return;
        var dist = this.el.object3D.position.distanceTo(player.object3D.position);
        if (dist < 6) { this.el.setAttribute('visible', 'false'); } else { this.el.setAttribute('visible', 'true'); }
      }
    });

    // 4. バグって激しく振動する演出
    AFRAME.registerComponent('jitter', {
      schema: { amount: {type: 'number', default: 0.05} },
      tick: function () {
        if (!this.basePos) { this.basePos = this.el.object3D.position.clone(); }
        this.el.object3D.position.set(
          this.basePos.x + (Math.random() - 0.5) * this.data.amount,
          this.basePos.y + (Math.random() - 0.5) * this.data.amount,
          this.basePos.z + (Math.random() - 0.5) * this.data.amount
        );
      }
    });

    // 5. 3Dオブジェクトのクリックイベント
    AFRAME.registerComponent('clickable-link', {
      schema: { url: { type: 'string' } },
      init: function () {
        this.el.addEventListener('click', () => { window.location.href = this.data.url; });
        this.el.addEventListener('mouseenter', () => { document.querySelector('a-cursor').setAttribute('color', '#00ff00'); });
        this.el.addEventListener('mouseleave', () => { document.querySelector('a-cursor').setAttribute('color', '#ff0000'); });
      }
    });
  </script>
</head>
<body>

  <div id="ui-overlay">
    <div class="scanlines"></div>
    <div class="vignette"></div>

    <div id="camcorder-ui">
      <div class="cam-rec"><span>●</span> REC</div>
      <div class="cam-battery">■■■</div>
      <div class="cam-center-cross">[ &nbsp; &nbsp; &nbsp; ]</div>
      <div class="cam-timecode" id="tc-display">00:00:00</div>
      <div class="cam-date">1996.07.14</div>
    </div>
