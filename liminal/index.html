<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Level 0 - The Backrooms</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <link rel="stylesheet" href="style.css">

  <script>
    // â˜… è¿½åŠ ï¼šæ­©ã„ãŸæ™‚ã ã‘è¶³éŸ³ã‚’é³´ã‚‰ã™ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ â˜…
    AFRAME.registerComponent('footstep-sound', {
      init: function () {
        this.lastPos = new THREE.Vector3();
        this.lastPos.copy(this.el.object3D.position);
        this.audio = document.getElementById("audio-footstep");
        this.isWalking = false;
      },
      tick: function () {
        if (!this.audio || !window.audioUnlocked) return;
        
        // ç¾åœ¨ã®ã‚«ãƒ¡ãƒ©ä½ç½®ã‚’å–å¾—
        var currentPos = this.el.object3D.position;
        // Xè»¸ã¨Zè»¸ï¼ˆå¹³é¢ï¼‰ã®ç§»å‹•è·é›¢ã‚’è¨ˆç®—ï¼ˆYè»¸ã®ä¸Šä¸‹å‹•ã¯ç„¡è¦–ï¼‰
        var dx = currentPos.x - this.lastPos.x;
        var dz = currentPos.z - this.lastPos.z;
        var dist = dx * dx + dz * dz;

        // ç§»å‹•ã—ã¦ã„ã‚Œã°å†ç”Ÿã€æ­¢ã¾ã‚Œã°ä¸€æ™‚åœæ­¢
        if (dist > 0.0001) {
          if (!this.isWalking) {
            this.audio.play().catch(()=>{});
            this.isWalking = true;
          }
        } else {
          if (this.isWalking) {
            this.audio.pause();
            this.isWalking = false;
          }
        }
        this.lastPos.copy(currentPos);
      }
    });
  </script>
</head>
<body>

  <div id="ui-overlay">
    <div class="scanlines"></div>
    <div class="vignette"></div>

    <div class="instructions">WASDã‚­ãƒ¼ã§ç§»å‹• / ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ã§è¦–ç‚¹ç§»å‹•</div>

    <div class="level-doors">
      <p style="margin: 0 0 10px 0; color: #8b0000; font-weight: bold; font-size: 14px;">ğŸšª åˆ¥ã®éšå±¤ã¸ã®æ‰‰</p>
      <a href="../dreamcore/index.html" class="door-link">â–¶ Level 1: Dreamcore</a>
      <a href="../vaporwave/index.html" class="door-link">â–¶ Level 2: Vaporwave</a>
      <a href="../aero/index.html" class="door-link">â–¶ Level 3: Frutiger Aero</a>
    </div>

    <a href="../index.html" class="exit-sign">EXIT â”</a>
    <img id="daisy-btn" src="../img/daisy%20bell.png" alt="Daisy Bell">
  </div>

  <audio id="audio-buzz" src="../assets/sfx/backrooms-buzzing-sound-effect.mp3" loop></audio>
  <audio id="audio-daisy" src="../assets/sfx/daisy-bell.mp3"></audio>
  <audio id="audio-footstep" src="../assets/sfx/walking%20on%20the%20carpet.mp3" loop></audio>

  <a-scene fog="type: exponential; color: #d1c7a3; density: 0.15">
    
    <a-assets>
      <a-asset-item id="backrooms-model" src="../assets/models/original_backrooms.glb"></a-asset-item>
      <a-asset-item id="car-model" src="../assets/models/destroyed_car_03__backrooms_car_gameready.glb"></a-asset-item>
    </a-assets>

    <a-entity id="rig" position="0 -2.5 0">
      <a-camera footstep-sound wasd-controls="acceleration: 15" look-controls="pointerLockEnabled: false"></a-camera>
    </a-entity>

    <a-gltf-model src="#backrooms-model" position="0 0 0" scale="1 1 1"></a-gltf-model>

    <a-gltf-model src="#car-model" position="15 0 -15" rotation="0 -45 0" scale="1 1 1"></a-gltf-model>

    <a-light type="ambient" color="#ffffff" intensity="0.3"></a-light>
    <a-light type="point" color="#fffae6" position="0 2.5 0" intensity="0.8" distance="15" 
             animation="property: intensity; from: 0.8; to: 0.3; dur: 120; dir: alternate; loop: true"></a-light>

  </a-scene>

  <script>
    // ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°
    window.audioUnlocked = false;

    document.addEventListener("DOMContentLoaded", () => {
      const buzz = document.getElementById("audio-buzz");
      const daisy = document.getElementById("audio-daisy");
      const footstep = document.getElementById("audio-footstep");
      const daisyBtn = document.getElementById("daisy-btn");

      // éŸ³é‡ãƒãƒ©ãƒ³ã‚¹
      buzz.volume = 0.3; 
      daisy.volume = 0.8;
      footstep.volume = 0.6; // è¶³éŸ³ã®éŸ³é‡

      // åˆå›ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç’°å¢ƒéŸ³ãªã©ã‚’å†ç”Ÿè¨±å¯
      const startAmbiance = () => {
        if (window.audioUnlocked) return;
        window.audioUnlocked = true;
        buzz.play().catch(console.error);
        daisy.play().catch(console.error);
      };

      document.getElementById("ui-overlay").addEventListener("click", startAmbiance, { once: true });
      document.getElementById("ui-overlay").addEventListener("touchstart", startAmbiance, { once: true });

      // Daisy Bellç”»åƒã‚¯ãƒªãƒƒã‚¯
      daisyBtn.addEventListener("click", (e) => {
        e.stopPropagation(); 
        daisy.currentTime = 0;
        daisy.play();
        daisyBtn.style.filter = "invert(1) blur(1px)";
        setTimeout(() => { 
          daisyBtn.style.filter = "sepia(0.8) contrast(1.2) brightness(0.6)"; 
        }, 100);
      });
    });
  </script>
</body>
</html>
