<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>tomoponzï½œãƒŸãƒ‹ã‚²ãƒ¼ãƒ </title>
  <meta name="description" content="ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼ï¼†2048">

  <link rel="stylesheet" href="style.css">
  <script defer src="app.js"></script>

  <style>
    /* === Games UI (site theme compatible) === */
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .tabs .btn{user-select:none}
    .tabs .btn.active{border-color:rgba(124,203,255,.35); box-shadow:0 0 0 3px rgba(124,203,255,.10)}
    .gameArea{margin-top:12px}

    .hud{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:10px}
    .hudLeft{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .hudRight{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .meter{display:flex; gap:10px; flex-wrap:wrap}
    .meter .pill{display:inline-flex; align-items:center; gap:8px}
    .tiny{font-size:12px;color:rgba(234,241,255,.70)}

    /* === Minesweeper === */
    .msWrap{display:grid; gap:12px}
    .msGrid{
      --cols:9;
      display:grid;
      grid-template-columns:repeat(var(--cols), 1fr);
      gap:6px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      touch-action:manipulation;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .cell{
      aspect-ratio:1/1;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.04);
      color:#EAF1FF;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .cell:hover{background:rgba(255,255,255,.07)}
    .cell.revealed{
      background:rgba(255,255,255,.02);
      border-color:rgba(255,255,255,.10);
      cursor:default;
    }
    .cell.flag{
      border-color:rgba(255,210,124,.35);
      box-shadow:0 0 0 3px rgba(255,210,124,.08)
    }
    .cell.mine{
      border-color:rgba(255,124,124,.35);
      box-shadow:0 0 0 3px rgba(255,124,124,.08)
    }

    /* === 2048 === */
    .g2048Wrap{display:grid; gap:12px}
    .board{
      width:min(460px, 100%);
      margin:0 auto;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      box-shadow:0 18px 60px rgba(0,0,0,.25);
    }
    .grid2048{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:10px;
    }
    .tile{
      aspect-ratio:1/1;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:22px;
      user-select:none;
    }
    .tile.v0{color:transparent}
    .tile.v2{box-shadow:0 0 0 3px rgba(124,203,255,.08)}
    .tile.v4{box-shadow:0 0 0 3px rgba(182,156,255,.08)}
    .tile.v8{box-shadow:0 0 0 3px rgba(124,255,178,.08)}
    .tile.v16{box-shadow:0 0 0 3px rgba(255,210,124,.10)}
    .tile.v32{box-shadow:0 0 0 3px rgba(255,124,124,.10)}
    .tile.v64{box-shadow:0 0 0 3px rgba(255,124,124,.14)}
    .tile.v128,.tile.v256,.tile.v512,.tile.v1024,.tile.v2048{box-shadow:0 0 0 3px rgba(124,255,178,.14)}
  </style>
</head>

<body>
  <!-- çµ±ä¸€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <header class="nav">
    <a class="brand" href="index.html" aria-label="tomoponz ãƒ›ãƒ¼ãƒ ">
      <span class="logo" aria-hidden="true"></span>
      <span class="brandText">
        <span class="brandName">tomoponz</span>
        <span class="brandSub" id="brandSub"></span>
      </span>
    </a>

    <nav class="navlinks" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
      <a class="chip" href="index.html">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
      <a class="chip" href="omikuji.html">ãŠã¿ãã˜</a>
      <a class="chip" href="shindan.html">è¨ºæ–­</a>
      <a class="chip" href="gallery.html">ãƒã‚¿ç½®ãå ´</a>
      <a class="chip" href="links.html">ãƒªãƒ³ã‚¯</a>
      <a class="chip" href="games.html">ã‚²ãƒ¼ãƒ </a>
      <a class="chip" href="door.html">ãƒ‰ã‚¢</a>
      <a class="chip" href="hachi.html">å…«ç™¾ç§‘äº‹å…¸</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="hero">
      <h1 class="h1">ãƒŸãƒ‹ã‚²ãƒ¼ãƒ </h1>
      <p class="sub">ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼ã¨2048ã€‚å‹é”ã«æŠ•ã’ã¦æ™‚é–“ã‚’æº¶ã‹ã›ã€‚</p>
      <div class="note">ã‚¹ãƒãƒ›ã§ã‚‚éŠã¹ã‚‹ã€‚ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼ã¯ã€Œæ——ãƒ¢ãƒ¼ãƒ‰ã€ã§æ“ä½œã—ã‚„ã™ãã—ã¦ã‚ã‚‹ã€‚</div>

      <div class="tabs">
        <button class="btn active" id="tab-ms" onclick="showTab('ms')">ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼</button>
        <button class="btn" id="tab-2048" onclick="showTab('2048')">2048</button>
        <a class="btn" href="gallery.html">ãƒã‚¿ç½®ãå ´ã¸æˆ»ã‚‹</a>
      </div>
    </section>

    <!-- Minesweeper -->
    <section class="gameArea" id="pane-ms">
      <div class="grid2">
        <div class="card">
          <h2>ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼</h2>
          <p class="muted">å·¦ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ï¼šé–‹ã / å³ã‚¯ãƒªãƒƒã‚¯ï¼šæ——ï¼ˆã‚¹ãƒãƒ›ã¯ã€Œæ——ãƒ¢ãƒ¼ãƒ‰ã€ï¼‰</p>

          <div class="hud">
            <div class="hudLeft">
              <span class="pill">é›£æ˜“åº¦ï¼š
                <select id="msDiff" style="margin-left:8px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,.16);border-radius:10px;padding:6px 10px">
                  <option value="easy">EASY 9Ã—9 / 10</option>
                  <option value="mid">MID 12Ã—12 / 24</option>
                  <option value="hard">HARD 16Ã—16 / 40</option>
                </select>
              </span>
              <button onclick="msNew()">æ–°ã—ãé–‹å§‹</button>
              <button id="msFlagBtn" onclick="msToggleFlagMode()">æ——ãƒ¢ãƒ¼ãƒ‰ï¼šOFF</button>
            </div>

            <div class="hudRight meter">
              <span class="pill">ğŸ’£ æ®‹ã‚Šï¼š<b id="msMinesLeft">10</b></span>
              <span class="pill">â± <b id="msTime">0</b>s</span>
              <span class="pill">çŠ¶æ…‹ï¼š<b id="msState">é€²è¡Œä¸­</b></span>
            </div>
          </div>

          <div class="msWrap" style="margin-top:12px">
            <div class="msGrid" id="msGrid" style="--cols:9"></div>
            <div class="note tiny">ã‚³ãƒ„ï¼šæ•°å­—ã¯å‘¨å›²8ãƒã‚¹ã®åœ°é›·æ•°ã€‚0ã¯é€£é–ã§é–‹ãã€‚</div>
          </div>
        </div>

        <div class="card">
          <h2>å‹é”ç”¨èª¬æ˜ï¼ˆé›‘ã«ï¼‰</h2>
          <ul class="list">
            <li>ã¾ãšã€Œæ–°ã—ãé–‹å§‹ã€æŠ¼ã›ã€‚</li>
            <li>æ•°å­—ï¼å‘¨ã‚Šã®åœ°é›·æ•°ã€‚</li>
            <li>åœ°é›·è¸ã‚“ã ã‚‰è² ã‘ã€‚å‹ã£ãŸã‚‰è‡ªæ…¢ã€‚</li>
          </ul>
          <hr class="sep">
          <div class="note">ã‚¹ãƒãƒ›ã¯ã€Œæ——ãƒ¢ãƒ¼ãƒ‰ONã€ã«ã—ã¦ã€ã‚¿ãƒƒãƒ—ã§æ——â†’ã‚‚ã†ä¸€åº¦ã§æˆ»ã™ã€‚</div>
        </div>
      </div>
    </section>

    <!-- 2048 -->
    <section class="gameArea" id="pane-2048" style="display:none">
      <div class="grid2">
        <div class="card">
          <h2>2048</h2>
          <p class="muted">PCï¼šçŸ¢å°ã‚­ãƒ¼ / ã‚¹ãƒãƒ›ï¼šã‚¹ãƒ¯ã‚¤ãƒ—</p>

          <div class="hud">
            <div class="hudLeft">
              <button onclick="gNew()">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            </div>
            <div class="hudRight meter">
              <span class="pill">Scoreï¼š<b id="gScore">0</b></span>
              <span class="pill">Bestï¼š<b id="gBest">0</b></span>
              <span class="pill">çŠ¶æ…‹ï¼š<b id="gState">é€²è¡Œä¸­</b></span>
            </div>
          </div>

          <div class="g2048Wrap" style="margin-top:12px">
            <div class="board" id="gBoard">
              <div class="grid2048" id="gGrid"></div>
            </div>
            <div class="note tiny">åŒã˜æ•°å­—ã‚’ã¶ã¤ã‘ã¦å€ã«ã™ã‚‹ã€‚2048ä½œã‚ŒãŸã‚‰å‹ã¡ï¼ˆã§ã‚‚ç¶šã‘ã¦ã‚‚è‰¯ã„ï¼‰ã€‚</div>
          </div>
        </div>

        <div class="card">
          <h2>å‹é”ã«è¨€ã†ä¸€è¨€</h2>
          <p class="muted">ã€Œã“ã®ã‚µã‚¤ãƒˆã€éŸ³æ¥½ã¨åœ°é›·ã¨æ•°å­—ã—ã‹ãªã„ã€‚æœ€é«˜ã€‚ã€</p>
          <hr class="sep">
          <div class="note">2048ã¯â€œè§’â€ã«æœ€å¤§æ•°ã‚’å›ºå®šã™ã‚‹ã®ãŒåŸºæœ¬æˆ¦è¡“ã€‚</div>
        </div>
      </div>
    </section>

    <div class="footer">Â© tomoponz / Mini Games</div>
  </main>

  <script>
    // ===== Tabs =====
    function showTab(which){
      const ms = document.getElementById("pane-ms");
      const g  = document.getElementById("pane-2048");
      const t1 = document.getElementById("tab-ms");
      const t2 = document.getElementById("tab-2048");

      if(which === "ms"){
        ms.style.display = "";
        g.style.display = "none";
        t1.classList.add("active");
        t2.classList.remove("active");
      }else{
        ms.style.display = "none";
        g.style.display = "";
        t1.classList.remove("active");
        t2.classList.add("active");
      }
      window.scrollTo({top:0, behavior:"smooth"});
    }

    // =======================
    // Minesweeper
    // =======================
    const MS = {
      rows: 9,
      cols: 9,
      mines: 10,
      grid: [],
      started: false,
      over: false,
      win: false,
      flagMode: false,
      minesLeft: 10,
      timer: 0,
      timerId: null
    };

    function msSetState(text){
      const el = document.getElementById("msState");
      if(el) el.textContent = text;
    }
    function msSetMinesLeft(n){
      const el = document.getElementById("msMinesLeft");
      if(el) el.textContent = String(n);
    }
    function msSetTime(n){
      const el = document.getElementById("msTime");
      if(el) el.textContent = String(n);
    }

    function msConfigFromDiff(){
      const v = document.getElementById("msDiff")?.value || "easy";
      if(v === "mid")  return {rows:12, cols:12, mines:24};
      if(v === "hard") return {rows:16, cols:16, mines:40};
      return {rows:9, cols:9, mines:10};
    }

    function msStopTimer(){
      if(MS.timerId) clearInterval(MS.timerId);
      MS.timerId = null;
    }
    function msStartTimer(){
      msStopTimer();
      MS.timer = 0;
      msSetTime(0);
      MS.timerId = setInterval(()=>{
        MS.timer++;
        msSetTime(MS.timer);
      }, 1000);
    }

    function msNew(){
      const cfg = msConfigFromDiff();
      MS.rows = cfg.rows;
      MS.cols = cfg.cols;
      MS.mines = cfg.mines;
      MS.minesLeft = cfg.mines;
      MS.started = false;
      MS.over = false;
      MS.win = false;
      msStopTimer();
      msSetTime(0);
      msSetMinesLeft(MS.minesLeft);
      msSetState("é€²è¡Œä¸­");

      // create empty grid
      MS.grid = [];
      for(let r=0;r<MS.rows;r++){
        const row = [];
        for(let c=0;c<MS.cols;c++){
          row.push({ mine:false, adj:0, revealed:false, flag:false });
        }
        MS.grid.push(row);
      }

      const gridEl = document.getElementById("msGrid");
      gridEl.style.setProperty("--cols", MS.cols);
      gridEl.innerHTML = "";

      for(let r=0;r<MS.rows;r++){
        for(let c=0;c<MS.cols;c++){
          const btn = document.createElement("button");
          btn.className = "cell";
          btn.type = "button";
          btn.dataset.r = String(r);
          btn.dataset.c = String(c);

          // å·¦ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—
          btn.addEventListener("click", (ev)=>{
            ev.preventDefault();
            msHandleClick(r,c);
          });

          // å³ã‚¯ãƒªãƒƒã‚¯ã§æ——
          btn.addEventListener("contextmenu", (ev)=>{
            ev.preventDefault();
            msToggleFlag(r,c);
          });

          gridEl.appendChild(btn);
        }
      }
    }

    function msToggleFlagMode(){
      MS.flagMode = !MS.flagMode;
      const b = document.getElementById("msFlagBtn");
      if(b) b.textContent = "æ——ãƒ¢ãƒ¼ãƒ‰ï¼š" + (MS.flagMode ? "ON" : "OFF");
    }

    function msInBounds(r,c){
      return r>=0 && r<MS.rows && c>=0 && c<MS.cols;
    }
    function msNeighbors(r,c){
      const list = [];
      for(let dr=-1;dr<=1;dr++){
        for(let dc=-1;dc<=1;dc++){
          if(dr===0 && dc===0) continue;
          const nr=r+dr, nc=c+dc;
          if(msInBounds(nr,nc)) list.push([nr,nc]);
        }
      }
      return list;
    }

    function msPlantMines(excludeR, excludeC){
      // mine positions
      const spots = [];
      for(let r=0;r<MS.rows;r++){
        for(let c=0;c<MS.cols;c++){
          if(r===excludeR && c===excludeC) continue;
          spots.push([r,c]);
        }
      }
      // shuffle
      for(let i=spots.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [spots[i], spots[j]] = [spots[j], spots[i]];
      }
      for(let i=0;i<MS.mines;i++){
        const [r,c] = spots[i];
        MS.grid[r][c].mine = true;
      }
      // calc adj
      for(let r=0;r<MS.rows;r++){
        for(let c=0;c<MS.cols;c++){
          if(MS.grid[r][c].mine){ MS.grid[r][c].adj = 0; continue; }
          const n = msNeighbors(r,c).reduce((s,[nr,nc])=> s + (MS.grid[nr][nc].mine?1:0), 0);
          MS.grid[r][c].adj = n;
        }
      }
    }

    function msCellEl(r,c){
      return document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
    }

    function msRenderCell(r,c){
      const cell = MS.grid[r][c];
      const el = msCellEl(r,c);
      if(!el) return;

      el.classList.toggle("revealed", cell.revealed);
      el.classList.toggle("flag", cell.flag);
      el.classList.toggle("mine", cell.revealed && cell.mine);

      if(cell.revealed){
        if(cell.mine){
          el.textContent = "ğŸ’£";
        }else if(cell.adj>0){
          el.textContent = String(cell.adj);
        }else{
          el.textContent = "";
        }
      }else{
        el.textContent = cell.flag ? "ğŸš©" : "";
      }
    }

    function msReveal(r,c){
      const start = MS.grid[r][c];
      if(start.revealed || start.flag) return;

      const q = [[r,c]];
      while(q.length){
        const [cr,cc] = q.shift();
        const cell = MS.grid[cr][cc];
        if(cell.revealed || cell.flag) continue;
        cell.revealed = true;
        msRenderCell(cr,cc);

        if(cell.mine) continue;
        if(cell.adj === 0){
          for(const [nr,nc] of msNeighbors(cr,cc)){
            const ncell = MS.grid[nr][nc];
            if(!ncell.revealed && !ncell.flag) q.push([nr,nc]);
          }
        }
      }
    }

    function msRevealAllMines(){
      for(let r=0;r<MS.rows;r++){
        for(let c=0;c<MS.cols;c++){
          const cell = MS.grid[r][c];
          if(cell.mine){
            cell.revealed = true;
            msRenderCell(r,c);
          }
        }
      }
    }

    function msCheckWin(){
      let safeRevealed = 0;
      let safeTotal = MS.rows*MS.cols - MS.mines;
      for(let r=0;r<MS.rows;r++){
        for(let c=0;c<MS.cols;c++){
          const cell = MS.grid[r][c];
          if(!cell.mine && cell.revealed) safeRevealed++;
        }
      }
      if(safeRevealed === safeTotal){
        MS.over = true;
        MS.win = true;
        msStopTimer();
        msSetState("å‹ã¡");
      }
    }

    function msHandleClick(r,c){
      if(MS.over) return;

      // æ——ãƒ¢ãƒ¼ãƒ‰ONãªã‚‰ã‚¯ãƒªãƒƒã‚¯=æ——
      if(MS.flagMode){
        msToggleFlag(r,c);
        return;
      }

      const cell = MS.grid[r][c];
      if(cell.flag || cell.revealed) return;

      if(!MS.started){
        MS.started = true;
        msPlantMines(r,c);     // åˆæ‰‹ã¯å®‰å…¨
        msStartTimer();
      }

      if(cell.mine){
        cell.revealed = true;
        msRenderCell(r,c);
        MS.over = true;
        MS.win = false;
        msStopTimer();
        msSetState("æ•—åŒ—");
        msRevealAllMines();
        return;
      }

      msReveal(r,c);
      msCheckWin();
    }

    function msToggleFlag(r,c){
      if(MS.over) return;
      const cell = MS.grid[r][c];
      if(cell.revealed) return;

      cell.flag = !cell.flag;
      MS.minesLeft += cell.flag ? -1 : +1;
      msSetMinesLeft(MS.minesLeft);
      msRenderCell(r,c);
    }

    // =======================
    // 2048
    // =======================
    const G = {
      board: [],
      score: 0,
      best: 0,
      state: "é€²è¡Œä¸­" // é€²è¡Œä¸­ / å‹ã¡ / è©°ã¿
    };

    const BEST_KEY = "g2048_best_v1";

    function gLoadBest(){
      const v = Number(localStorage.getItem(BEST_KEY) || "0");
      G.best = Number.isFinite(v) ? v : 0;
      document.getElementById("gBest").textContent = String(G.best);
    }
    function gSaveBest(){
      localStorage.setItem(BEST_KEY, String(G.best));
    }

    function gNew(){
      gLoadBest();
      G.score = 0;
      G.state = "é€²è¡Œä¸­";
      document.getElementById("gScore").textContent = "0";
      document.getElementById("gState").textContent = G.state;

      G.board = Array.from({length:4}, ()=> Array(4).fill(0));
      gSpawn();
      gSpawn();
      gRender();
    }

    function gSpawn(){
      const empties = [];
      for(let r=0;r<4;r++){
        for(let c=0;c<4;c++){
          if(G.board[r][c]===0) empties.push([r,c]);
        }
      }
      if(!empties.length) return;
      const [r,c] = empties[Math.floor(Math.random()*empties.length)];
      G.board[r][c] = Math.random() < 0.9 ? 2 : 4;
    }

    function gRender(){
      const grid = document.getElementById("gGrid");
      if(!grid) return;

      // ensure 16 tiles exist
      if(grid.children.length !== 16){
        grid.innerHTML = "";
        for(let i=0;i<16;i++){
          const d = document.createElement("div");
          d.className = "tile v0";
          d.textContent = "";
          grid.appendChild(d);
        }
      }
      let i=0;
      for(let r=0;r<4;r++){
        for(let c=0;c<4;c++){
          const v = G.board[r][c];
          const el = grid.children[i++];
          el.className = "tile v"+v;
          el.textContent = v===0 ? "" : String(v);
        }
      }
      document.getElementById("gScore").textContent = String(G.score);
      document.getElementById("gBest").textContent = String(G.best);
      document.getElementById("gState").textContent = G.state;
    }

    function gHas2048(){
      for(let r=0;r<4;r++) for(let c=0;c<4;c++) if(G.board[r][c]===2048) return true;
      return false;
    }
    function gCanMove(){
      for(let r=0;r<4;r++){
        for(let c=0;c<4;c++){
          const v = G.board[r][c];
          if(v===0) return true;
          if(r<3 && G.board[r+1][c]===v) return true;
          if(c<3 && G.board[r][c+1]===v) return true;
        }
      }
      return false;
    }

    function gSlideLine(line){
      // remove zeros
      const a = line.filter(x=>x!==0);
      let gain = 0;
      for(let i=0;i<a.length-1;i++){
        if(a[i]!==0 && a[i]===a[i+1]){
          a[i] *= 2;
          gain += a[i];
          a[i+1] = 0;
          i++;
        }
      }
      const b = a.filter(x=>x!==0);
      while(b.length<4) b.push(0);
      return {line:b, gain};
    }

    function gMove(dir){
      if(G.state !== "é€²è¡Œä¸­") return;

      const before = JSON.stringify(G.board);
      let gained = 0;

      if(dir==="left"){
        for(let r=0;r<4;r++){
          const {line, gain} = gSlideLine(G.board[r]);
          G.board[r] = line;
          gained += gain;
        }
      }
      if(dir==="right"){
        for(let r=0;r<4;r++){
          const rev = [...G.board[r]].reverse();
          const {line, gain} = gSlideLine(rev);
          G.board[r] = line.reverse();
          gained += gain;
        }
      }
      if(dir==="up"){
        for(let c=0;c<4;c++){
          const col = [G.board[0][c],G.board[1][c],G.board[2][c],G.board[3][c]];
          const {line, gain} = gSlideLine(col);
          for(let r=0;r<4;r++) G.board[r][c]=line[r];
          gained += gain;
        }
      }
      if(dir==="down"){
        for(let c=0;c<4;c++){
          const col = [G.board[0][c],G.board[1][c],G.board[2][c],G.board[3][c]].reverse();
          const {line, gain} = gSlideLine(col);
          const out = line.reverse();
          for(let r=0;r<4;r++) G.board[r][c]=out[r];
          gained += gain;
        }
      }

      const after = JSON.stringify(G.board);
      if(before === after) return; // no move

      G.score += gained;
      if(G.score > G.best){
        G.best = G.score;
        gSaveBest();
      }

      gSpawn();

      if(gHas2048()) G.state = "å‹ã¡";
      else if(!gCanMove()) G.state = "è©°ã¿";

      gRender();
    }

    // keyboard
    window.addEventListener("keydown", (e)=>{
      const key = e.key;
      if(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(key)){
        e.preventDefault();
        if(key==="ArrowLeft") gMove("left");
        if(key==="ArrowRight") gMove("right");
        if(key==="ArrowUp") gMove("up");
        if(key==="ArrowDown") gMove("down");
      }
    }, {passive:false});

    // swipe
    (function(){
      const board = document.getElementById("gBoard");
      if(!board) return;
      let sx=0, sy=0;
      board.addEventListener("touchstart", (e)=>{
        const t = e.touches[0];
        sx=t.clientX; sy=t.clientY;
      }, {passive:true});
      board.addEventListener("touchend", (e)=>{
        const t = e.changedTouches[0];
        const dx = t.clientX - sx;
        const dy = t.clientY - sy;
        if(Math.max(Math.abs(dx), Math.abs(dy)) < 30) return;
        if(Math.abs(dx) > Math.abs(dy)){
          gMove(dx>0 ? "right" : "left");
        }else{
          gMove(dy>0 ? "down" : "up");
        }
      }, {passive:true});
    })();

    // init
    document.addEventListener("DOMContentLoaded", ()=>{
      msNew();
      gNew();
    });
  </script>
</body>
</html>
